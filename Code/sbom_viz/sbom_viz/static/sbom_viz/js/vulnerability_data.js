let fetchedData = null; // try and save the data for later use to save time

export async function getVulnerabilityData(){

    
    if (fetchedData != null)
        return Promise.resolve(fetchedData);
           
    // Try to fetch from sec-info,
    // if we encounter an error than alert the user
    try {
        const response = await fetch("http://127.0.0.1:8000/sec-info/");
        if (response.ok){
            document.querySelector('#loading').remove();
            document.querySelector('.analysis-content.hidden').classList.remove('hidden');
            const json = await response.json();
            return json.Summary;
        }
        throw new Error('Something went wrong when gathering security information')
    }
    catch (error) {
        document.querySelector('#loading').innerHTML = `Sorry!<br>${error}`

        alert("Sorry, something went wrong when gathering security information from the inputted SBOM. Neither bomber nor trivy were able to parse the file. Please try again with another file.")
        console.log(error);
    }
}

export async function getVulnerabilityTableData(){
    const json = await getVulnerabilityData();
    const processedData = Object.keys(json.Top_10).map(key => {
        const item = json.Top_10[key];
        return {
            component_name: item.SBOM_ID,
            cve_id: key,
            score: item.Displayed_CVSS,
            severity: item.Severity,
            description: item.Description
        };
    });
    return processedData;
}

export async function getVulnerabilityDistribution(){
    const json = await getVulnerabilityData();
    return json.SeverityDistr;
}

fetchedData = getVulnerabilityData();